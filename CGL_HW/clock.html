<html>
<head>
<style>
#button{
  position:absolute;
  top:3%;
  width:100%;
  text-align:center;
}

</style>
</head>
<body>
<div id='button'>
  <font color="white">hold 3s pause button to reset</font>
  <br>
  <button id='start'>
    Start
  </button>
  <button id='add'>
    +10s
  </button>
  <br>
  <button id='change'>
    Change to Quartz style
  </button>
</div>

<audio preload="auto" src="https://www.youtube.com/watch?v=iNpXCzaWW1s" id='sound'></audio>

<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="https://jyunming-chen.github.io/tutsplus/js/KeyboardState.js"></script>

<script type="module">
import * as THREE from 'https://cdn.skypack.dev/three@0.136';
import { OrbitControls } from 'https://cdn.skypack.dev/three@0.136/examples/jsm/controls/OrbitControls.js';

var camera, renderer, scene;
var second;
var time = 0;
var start_bt = false,
  add_bt = false,
  change_bt = false;
var hold = 0;

init();
animate();

function init() {
  let width = window.innerWidth;
  let height = window.innerHeight;

  renderer = new THREE.WebGLRenderer();
  renderer.setSize(width, height);
  renderer.setClearColor('grey');
  document.body.appendChild(renderer.domElement);

  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(60, width / height, 1, 1000);
  camera.position.set(0, 0, 50);

  let controls = new OrbitControls(camera, renderer.domElement);

  clock_create();
}

function clock_create() {
  let clock_night = new THREE.Mesh(new THREE.RingGeometry(15, 20, 12, 1, 4.71, Math.PI), new THREE.MeshBasicMaterial({
    color: 0x1858ed,
    side: THREE.DoubleSide
  }));

  let clock_day = new THREE.Mesh(new THREE.CircleGeometry(17, 12, Math.PI / 2, Math.PI), new THREE.MeshBasicMaterial({
    color: 0xebbc13,
    side: THREE.DoubleSide
  }));

  let vertices2 = [];

  vertices2.push(
    new THREE.Vector3(0, 2, 0),
    new THREE.Vector3(-1, 0, 0),
    new THREE.Vector3(1, 0, 0)
  )

  let indices2 = [];
  indices2.push(0, 1, 2);

  var geometry2 = new THREE.BufferGeometry().setFromPoints(vertices2);
  geometry2.setIndex(indices2);

  var tri = new THREE.Object3D();

  var tri1 = new THREE.Mesh(geometry2, new THREE.MeshBasicMaterial({
    color: 0xebbc13,
    side: THREE.DoubleSide
  }));

  var tri2 = new THREE.Mesh(geometry2, new THREE.MeshBasicMaterial({
    color: 0xebbc13,
    side: THREE.DoubleSide
  }));

  var tri3 = new THREE.Mesh(geometry2, new THREE.MeshBasicMaterial({
    color: 0xebbc13,
    side: THREE.DoubleSide
  }));

  var tri4 = new THREE.Mesh(geometry2, new THREE.MeshBasicMaterial({
    color: 0xebbc13,
    side: THREE.DoubleSide
  }));

  var tri5 = new THREE.Mesh(geometry2, new THREE.MeshBasicMaterial({
    color: 0xebbc13,
    side: THREE.DoubleSide
  }));

  var tri6 = new THREE.Mesh(geometry2, new THREE.MeshBasicMaterial({
    color: 0xebbc13,
    side: THREE.DoubleSide
  }));

  var tri7 = new THREE.Mesh(geometry2, new THREE.MeshBasicMaterial({
    color: 0xebbc13,
    side: THREE.DoubleSide
  }));

  tri1.position.set(-7, 17, 0);
  tri1.rotation.z = Math.PI / 10;

  tri2.position.set(-13, 13, 0);
  tri2.rotation.z = Math.PI / 4.5;

  tri3.position.set(-17, 7, 0);
  tri3.rotation.z = Math.PI / 3;

  tri4.position.set(-18, 0, 0);
  tri4.rotation.z = Math.PI / 2;

  tri5.position.set(-17, -7, 0);
  tri5.rotation.z = Math.PI * 2 / 3;

  tri6.position.set(-13, -13, 0);
  tri6.rotation.z = Math.PI / 1.3;

  tri7.position.set(-7, -17, 0);
  tri7.rotation.z = Math.PI / 1.15;

  tri.add(tri1, tri2, tri3, tri4, tri5, tri6, tri7);

  let second_md = new THREE.Mesh(new THREE.CircleGeometry(1, 12, Math.PI, Math.PI), new THREE.MeshBasicMaterial({
    color: 0x000000,
    side: THREE.DoubleSide
  }));

  let vertices = [];

  vertices.push(
    new THREE.Vector3(1, 0, 0),
    new THREE.Vector3(0, 20, 0),
    new THREE.Vector3(-1, 0, 0),
  );

  var geometry = new THREE.BufferGeometry().setFromPoints(vertices);

  let indices = [];
  indices.push(0, 1, 2);
  geometry.setIndex(indices);

  let second_long = new THREE.Mesh(geometry, new THREE.MeshBasicMaterial({
    color: 0xffffff,
    side: THREE.DoubleSide
  }));

  second = new THREE.Mesh();

  second.add(second_md, second_long);
  second.position.z = 0.1;
  scene.add(second);

  var clock = new THREE.Object3D();
  clock.add(clock_day, clock_night, tri);
  scene.add(clock);
}

//holding start over 1s to reset
start.addEventListener("mousedown", function() {
  hold = Date.now();
});
start.addEventListener("mouseup", function() {
  if (1000 < Date.now() - hold) {
    time = 0;
    second.rotation.z = time;
  }
});

//start the clock
$("#start").click(function() {
  start_bt = !start_bt;
});

//add 10s
$("#add").click(function() {

  if (time > -Math.PI / 3 * 5) {
    time = time - 2 * Math.PI / 6;
    second.rotation.z = time;
  } else {
    time = -2 * Math.PI;
    second.rotation.z = time;
  }

});

//switch the type of clock
$("#change").click(function() {
  change_bt = !change_bt;

  if (change_bt) {
    setTimeout(animate, 0);
    $("#change").text('Change to Normal style');
  } else
    $("#change").text('Change to Quartz style');

});

/* function print() {

  time += Math.PI * 2 / 3600 * 25;
  second.rotation.z = time;

  if (change_bt && time < 0)
    setTimeout(print, 1000);
  else
    requestAnimationFrame(animate);
} */

function animate() {
  //change the text at Start button
  if (!start_bt)
    $("#start").text('Start');
  else
    $("#start").text('Pause');

  //start button is on
  if (start_bt) {
    //still have time
    if (time < 0) {
      //Quartz style
      if (change_bt) {
        time += Math.PI * 2 / 3600 * 25;
        second.rotation.z = time;
        if(time >= 0.0)
          document.getElementById('sound').play();
        setTimeout(animate, 1000);
      }
      //Normal style
      else {
        time += Math.PI * 2 / 3600 * 25 / 60;
        second.rotation.z = time;
        if(time >= 0.0)
          document.getElementById('sound').play();
        requestAnimationFrame(animate);
      }
    }
    //time is already 0s
    else {
      start_bt = !start_bt;
    }

  }
  //start button is off
  else {
    if (change_bt)
      requestAnimationFrame(animate);
    else
      requestAnimationFrame(animate);
  }

  renderer.render(scene, camera);
}

</script>
</body>
</html>