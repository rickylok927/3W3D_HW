<html>
<head>
<style>
#button{
  position:absolute;
  top:5%;
  width:100%;
  text-align:center;
}
</style>
</head>
<body>
<div id='button'>
  <button id='view'>
    Change View
  </button>
  <br>
  <font color="white">
	↑
	<br>
	← ↓ →
	<br>
	space
  </font>
</div>


<script src="https://jyunming-chen.github.io/tutsplus/js/KeyboardState.js"></script>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

<script type="module">
import * as THREE from 'https://cdn.skypack.dev/three@0.136';
import { OrbitControls } from 'https://cdn.skypack.dev/three@0.136/examples/jsm/controls/OrbitControls.js';

var camera, renderer, scene;
var camera3rd;
var width = window.innerWidth,
  height = window.innerHeight;
var view_bt = false;
var power = 5,
  angle = 0;
var keyboard = new KeyboardState();
var pos = new THREE.Vector3();
var vel = new THREE.Vector3();
var force = new THREE.Vector3();
var car;
var spotLight;
var clock = new THREE.Clock();

(function() {
  Math.clamp = function(val, min, max) {
    return Math.min(Math.max(val, min), max);

  }
})();

init();
animate();

function init() {
  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(50, width / height, 1, 1000);
  camera.position.set(100, 20, 0);
  scene.add(camera);

  camera3rd = new THREE.PerspectiveCamera(80, width / height, 1, 1000);

  var floor = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshLambertMaterial());
  floor.rotation.x = -Math.PI / 2;
  scene.add(floor);

  renderer = new THREE.WebGLRenderer();
  renderer.setSize(width, height);
  renderer.setClearColor('gray');

  var controls = new OrbitControls(camera, renderer.domElement);

  document.body.appendChild(renderer.domElement);

  var axes = new THREE.AxesHelper(20);
  scene.add(axes);

  car = modeling();
  scene.add(car);

  spotLight = new THREE.SpotLight(0xffffff, 1.5);
  spotLight.position.set(0, 150, 0);
  spotLight.angle = 0.3;
  spotLight.penumbra = 0.9;
  spotLight.target = car;
  scene.add(spotLight);

}

function animate() {

  var thirdPos = car.localToWorld(new THREE.Vector3(-15, 15, 0));
  var thirdAt = car.localToWorld(new THREE.Vector3(10, 2.5, 0));
  camera3rd.position.copy(thirdPos);
  camera3rd.lookAt(thirdAt);

  var dt = clock.getDelta();
  update(dt);

  car.position.copy(pos);
  car.rotation.y = angle;

  requestAnimationFrame(animate);

  if (view_bt)
    renderer.render(scene, camera3rd);
  else
    renderer.render(scene, camera);

}

function modeling() {
  var mt = new THREE.MeshNormalMaterial();
  var main = new THREE.Object3D();

  var cube1 = new THREE.Mesh(new THREE.BoxGeometry(15, 5, 7.5), mt);
  cube1.position.y=2.5;
  var cube2 = new THREE.Mesh(new THREE.BoxGeometry(5, 5, 5), mt);
  cube2.position.set(-2,7.5,0);

  main.add(cube1, cube2);
  return main;
}

function update(dt) {

  keyboard.update();

  if (vel.length() > 0) {
    angle = 1.5 * Math.PI + Math.atan2(vel.x, vel.z);
  }

  if (keyboard.pressed("space"))
    power = 0.1;
  if (keyboard.pressed("up"))
    power *= 1.2;
  if (keyboard.pressed("down"))
    power /= 1.2;

  power = Math.clamp(power, 0, 120.0);


  var angle_thrust = angle;
  if (keyboard.pressed("left"))
    angle_thrust += 0.7;
  if (keyboard.pressed("right"))
    angle_thrust -= 0.7;

  var thrust = new THREE.Vector3(1, 0, 0).multiplyScalar(power).applyAxisAngle(new THREE.Vector3(0, 1, 0), angle_thrust);
  force.copy(thrust);
  force.add(vel.clone().multiplyScalar(-2))

  vel.add(force.clone().multiplyScalar(dt));
  pos.add(vel.clone().multiplyScalar(dt));
}

$("#view").click(function() {
  view_bt = !view_bt;
});

//keyboard
//button


</script>
</body>
</html>